% lecture-registers.sty
% Author: Florian Sihler, 21.10.2020

% Register Support for lectures
\ProvidesPackage{lecture-registers}[2020/10/21 v1.0 registers]

\newif\iflecture@registers@disable@
\DeclareOption{disable}{\lecture@registers@disable@true}
\DeclareOption{enable}{\lecture@registers@disable@false}
\ProcessOptions*

\iflecture@registers@disable@\expandafter\endinput\fi

\RequirePackage{etoolbox}

\def\@lecture@definereg#1{%
\expandafter\gdef\csname#1\endcsname{\expandafter\@dblarg\csname @#1@@\endcsname}
\expandafter\xdef\csname @#1@@\endcsname[##1]##2%
    {\expandafter\noexpand\gdef\csname lecture@register@#1\endcsname{##2}%
        \expandafter\noexpand\gdef\csname lecture@register@short@#1\endcsname{##1}}
\expandafter\gdef\csname lecture@register@#1\endcsname{}
\expandafter\gdef\csname lecture@register@short@#1\endcsname{}
}

\forcsvlist{\@lecture@definereg}{title,subtitle,subject,brief,author,date,duedate,supervisor,keywords,titleimage,authority,copyright}

% iterators for handling and parsing author information.
\def\lecture@@add@author#1{%
\let\lecture@@tmp@old@author\lecture@register@author
\ifx\lecture@@tmp@old@author\@empty
\xdef\lecture@register@author{#1}\else
\xdef\lecture@register@author{\lecture@@tmp@old@author,#1}\fi
}
\let\addAuthor\lecture@@add@author

\def\lecture@mail#1{\href{mailto:#1}{#1}}
\let\mail\lecture@mail

\def\lecture@@mail@unknown{??}
\def\lecture@@parse@author#1 (#2)#3\@nil{%
    \def\@tmpa{#2}\ifx\@tmpa\lecture@@mail@unknown#1\else\href{mailto:#2}{#1}\fi}

\def\LinkAuthor#1{\protected@edef\@tmp{#1}\expandafter\lecture@@parse@author\@tmp{} (??)??\@nil}

\newcounter{lecture@counter@tmp@a}
\def\lecture@@typeset@author#1{%
\setcounter{lecture@counter@tmp@a}{0}% start with an offset
\foreach \@tmp in {#1}%
    {\ifx\@tmp\@empty\else\addtocounter{lecture@counter@tmp@a}\@ne\fi}%
\edef\lecture@author@totallength{\arabic{lecture@counter@tmp@a}}%
\setcounter{lecture@counter@tmp@a}{0}% stored the length of the list
\foreach \lecture@@tmp@curauthor in {#1} {%
\ifx\lecture@@tmp@curauthor\@empty
\else\addtocounter{lecture@counter@tmp@a}\@ne
    \ifnum\thelecture@counter@tmp@a>1 %
    \ifnum\thelecture@counter@tmp@a=\lecture@author@totallength\relax
        ~und \else,\space\fi\fi
    \expandafter\lecture@@parse@author\lecture@@tmp@curauthor{} (??)??\@nil
\fi
}}

\newcommand*\lecture@typeset@authors{\protected@edef\@tmp{\noexpand\lecture@@typeset@author{\lecture@register@author}}\@tmp}
\let\typesetAuthor\lecture@typeset@authors
\let\typesetAuthors\lecture@typeset@authors

\def\lecture@firstoftwo#1#2{#1}
\def\lecture@secondoftwo#1#2{#2}

\def\lecture@r#1{\csname lecture@register@#1\endcsname}
\def\lecture@@chkempty{\ifx\@@lecture@tmp\@empty\expandafter\lecture@firstoftwo\else\expandafter\lecture@secondoftwo\fi}
\def\iflecture@e#1{\protected@edef\@@lecture@tmp{#1}\lecture@@chkempty}
\def\iflecture@er#1{\protected@edef\@@lecture@tmp{\lecture@r{#1}}\lecture@@chkempty}
\def\lecture@rs#1{\csname lecture@register@short@#1\endcsname}
\def\iflecture@ers#1{\protected@edef\@@lecture@tmp{\lecture@rs{#1}}\lecture@@chkempty}

% public register access
\let\lectureGetRegister\lecture@r
\let\lectureGetRegisterShort\lecture@rs

\AtBeginDocument{%
\@ifpackageloaded{hyperref}{%
\hypersetup{pdftitle={\lecture@r{title}},%
    pdfsubject={\lecture@r{subtitle}},%
    pdfauthor={\lecture@r{author}},%
    pdfkeywords={\lecture@r{keywords}}}%
}{}%
}

% link the defaults:
\def\@title{\lecture@r{title}}
\def\@author{\lecture@r{author}}
\def\@date{\lecture@r{date}}
\def\@subtitle{\lecture@r{subtitle}}
\def\@subject{\lecture@r{subject}}
\endinput