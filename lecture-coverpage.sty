%% lecture-coverpage.sty
%%
%% --------------------------------------------------------------------------
%%
%% Autor: Florian Sihler, 21.10.2020
%%
%% Coverpage generation based on the lilly-philosopher generation
%%
\ProvidesPackage{lecture-coverpage}[2020/10/21 v1.0 coverpages]

\RequirePackage{lecture-registers}
% ghost requires: tikz & geometry & tikz-palettes <- this should be optional
\AtEndPreamble{%
    \RequirePackage{tikz,geometry,tikz-palettes}%
    \usetikzlibrary{decorations.text}%
}

\def\lecturecp@emblemcolor{gray}
\def\lecturecp@emblemcolor@symbol{gray}
% Emblem
\def\lecture@emblem{}

 % #1: university #2 Text, #3 Symbol centered
\newcommand*\emblem[3][ulm university]{\def\@@university@name{#1}%
 \gdef\lecture@emblem{\lecture@generate@emblem{#2}{\hspace*{-0.025em}#3}{\lecturecp@emblemcolor}{\lecturecp@emblemcolor@symbol}{\lecturecp@emblemcolor}{51pt}{\lecture@font@eulerSmall}{0.125}{0.05}}%
}

\DeclareFixedFont{\lecture@font@eulerNormal}{U}{eur}{b}{n}{\f@size}
\DeclareFixedFont{\lecture@font@eulerSmall}{U}{eur}{b}{n}{9}

\def\@@university@name{ulm university}

% The code is based on the emblem generation algorithm of lilly

%% Upper Text %% Symbol %% WHITE Color %% BACK Color %% Tikz %% Size %% FONTSIZE UPPER
\def\lecture@generate@emblem#1#2#3#4#5#6#7#8#9{%
% #1 Upper Text [Mathematik,...]
% #2 Symbol to be displayed [$\pi$], can be theoretically everything.
% #3 'White' Color, mainly the color of the outer Ring
% #4 Color of the Symbol
% #5 Tikz picture Arguments (main color)
% #6 Fontsize of the Symbol
% #7 Extra font-options for the upper text
% #8 Offset for the text radius
% #9 Offset for the Shadow of the symbol #2
 \begin{tikzpicture}[#5]%
     % Draw the upper Text in color #3 and extra formatting #7
     \draw [decorate,decoration={text along path,text align=center,%
             text={|\footnotesize\lecture@font@eulerNormal\color{#3}#7|#1}}]% Upper text
         (-1.275-#8,0) arc [start angle=180, end angle=00, radius=1.275+#8];% Offset #8

     % Draw the two bullets in the main color of the tikzpicture
     \draw(-1.5,0) node {{$\bullet$}} ++ (3,0) node {{$\bullet$}};
     % Draw the lower text (\@@university@name) in color #3
     \draw [decorate,decoration={text along path,text align=center,
             text={|\footnotesize\lecture@font@eulerNormal\color{#3}|\@@university@name}}]
         (-1.6,0) arc [start angle=-180, end angle=00, radius=1.6];
     % Draw the inner thick circle in #3
     \draw[very thick, color=#3] (0,0) circle (1.25);
     % Draw the outer thick circle in #3
     \draw[thick, color=#3] (0,0) circle (1.75);
     % Draw the inner 'dot' circle in #3
     \draw[thin, color=#3] circle (1.2);
     % Draw the dots on the inner 'dot' circle in #3
     \foreach \r in {0,24,...,360} {
         \filldraw[#3] (\r:1.2) circle (0.01) node[circle,inner sep=0.222em] (\r) {};
     }
     % Draw the connection-lines in the main color of the tikzpicture
     \foreach \r in {0,24,...,360}  {
         \foreach \rr in {0,24,...,\r}{
             \draw[very thin] (\r) -- (\rr);
         }
     }
     % Draw the symbol #2 shading with an offset of #9 and a size of #6
     \node[opacity=0.5] at(0.02+#9,-#9) {\fontsize{#6}{16pt}\selectfont#2};
     % Draw the symbol #2 with size #6 (same as shadow), color of #4
     \draw (0.02,0) node {\fontsize{#6}{16pt}\selectfont\color{#4}#2};
\end{tikzpicture}%
}


\long\def\lecturecp@coverpagestyle#1#2{%
    \expandafter\gdef\csname lecturecp@style@#1@\endcsname{#2}%
}
% maybe insert guards if not found?
\def\selectcoverpage#1{\gdef\lecturecp@activecoverpage{#1}}
\selectcoverpage{}

\AtEndPreamble{\expandafter\ifx\expandafter!\lecturecp@activecoverpage!\else\@nameuse{lecturecp@style@\lecturecp@activecoverpage @}\fi}

\lecturecp@coverpagestyle{plain}{%
\def\lecture@coverpage@geometry{\newgeometry{width=0.85\paperwidth,top=.15\paperheight,bottom=.07\paperheight,centering}}

\renewcommand{\maketitle}{%
\thispagestyle{empty}\thispdfpagelabel{Cover}%
\lecture@coverpage@geometry%
\begin{titlepage}%
\parbox{0.99\linewidth}{\raggedright\fontsize{50pt}{50pt}\selectfont\sffamily\iflecture@er{title}{Title missing. Set with \texttt{\textbackslash title\{hey\}}}{\lecture@r{title}}\leavevmode\bigskip\\*}\par
\parbox{0.99\linewidth}{\fontsize{17pt}{17pt}\selectfont\sffamily\lecture@r{subtitle}}\leavevmode\\%
\vfill% set the titleimage
\parbox[c][0.55\paperwidth]{\linewidth}{\centering\hbox{}\vfill%
    \lecture@r{titleimage}%
\vfill\hbox{}}\leavevmode\\
\vfill%
\parbox[c]{0.75\linewidth}{%
\fontsize{17pt}{17pt}\selectfont\sffamily\color{gray}\lecture@r{brief}%
}\hfill\parbox[c]{0.2\linewidth}{\lecture@emblem}%
\end{titlepage}%
\restoregeometry{}\clearpage}
}

\lecturecp@coverpagestyle{plain-small}{%
\def\lecture@coverpage@geometry{\newgeometry{width=0.85\paperwidth,top=.15\paperheight,bottom=.07\paperheight,centering}}

\renewcommand{\maketitle}{%
\thispagestyle{empty}\thispdfpagelabel{Cover}%
\lecture@coverpage@geometry%
\begin{titlepage}%
\parbox{0.99\linewidth}{\raggedright\fontsize{35pt}{35pt}\selectfont\sffamily\iflecture@er{title}{Title missing. Set with \texttt{\textbackslash title\{hey\}}}{\lecture@r{title}}\leavevmode\bigskip\\*}\par
\parbox{0.99\linewidth}{\fontsize{15pt}{15pt}\selectfont\sffamily\lecture@r{subtitle}}\leavevmode\\%
\vfill% set the titleimage
\parbox[c][0.55\paperwidth]{\linewidth}{\centering\hbox{}\vfill%
    \lecture@r{titleimage}%
\vfill\hbox{}}\leavevmode\\
\vfill%
\parbox[c]{\linewidth}{%
\fontsize{15pt}{15pt}\selectfont\sffamily\color{gray}\lecture@r{brief}%
}%
\end{titlepage}%
\restoregeometry{}\clearpage}%
}

\lecturecp@coverpagestyle{fancy}{%
\def\lecture@coverpage@geometry{\newgeometry{margin=0pt}}

\def\lecturecp@emblemcolor{white}
\def\lecturecp@emblemcolor@symbol{paletteA}
\def\lecturecp@height{3}
\def\lecturecp@leftwidth{2cm}%

\renewcommand{\maketitle}{\bgroup%
\setlength\parindent{0pt}%
\thispagestyle{empty}\thispdfpagelabel{Cover}%
%
\lecture@coverpage@geometry%
%
\begin{titlepage}%
%
%
%
% At last we place the bannerblock%
\null\vfill%
\begin{tikzpicture}%
    \draw[thick,paletteA]
        (0,\lecturecp@height+0.1) -- ++(0.6\paperwidth-0.1,0)
        -- ++(0.1\paperwidth, 1)  -- ++(0.1\paperwidth+0.1,0)
        -- ++(0.1\paperwidth,-1)  -- ++(0.1\paperwidth,0) ;
    \draw[thin,paletteA]
        (0,\lecturecp@height+0.175) -- ++ (0.6\paperwidth-0.175,0)
        -- ++(0.1\paperwidth,1)     -- ++(0.1\paperwidth+0.175,0)
        --  ++(0.1\paperwidth,-1)   -- ++(0.1\paperwidth,0);
    \filldraw[paletteA]
        (0,0) -- ++(\paperwidth,0) -- ++(0,\lecturecp@height)
        -- ++(-0.1\paperwidth,0)   -- ++(-0.1\paperwidth,1)
        -- ++(-0.1\paperwidth,0)   --  ++(-0.1\paperwidth,-1)
        -- ++(-0.6\paperwidth,0) -- cycle;%
    \begin{scope}[every node/.style={color=\lecturecp@emblemcolor!60!paletteA}]%
        \node at(0.75\paperwidth,2) {\lecture@emblem};
        \node[right] at(\lecturecp@leftwidth,1.5)% Text: TODO: METAINFOS
        {\parbox{9.9cm}{\footnotesize\bfseries{\par}}};
        \node[above left] at(\paperwidth,0.5) {\tiny\textsf{Ver. \lithie@version}};%
        \node[above left] at(\paperwidth,0.02) {\begingroup\hypersetup{urlcolor=\lecturecp@emblemcolor}\href{https://github.com/EagleoutIce/lithie-util}{\Lithie}\endgroup};%
    \end{scope}%
\end{tikzpicture}%
\end{titlepage}%
\restoregeometry{}\clearpage\egroup}
}

\endinput