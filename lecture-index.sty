%% lecture-index.sty
%%
%% --------------------------------------------------------------------------
%%
%% Autor: Florian Sihler, 8.10.2020
%%
%% Makeindex control

\ProvidesPackage{lecture-index}[2020/10/08 v1.0 Index control]

\RequirePackage{kvoptions}
\SetupKeyvalOptions{family=LECIDX, prefix=LECIDX@}
\DeclareStringOption[true]{automatic}[false]

\RequirePackage{imakeidx,letltxmacro,etoolbox,xstring}
\def\indexname{Stichwortverzeichnis}
\edef\lecture@imkdx{\noexpand\makeindex[title=\indexname,columns=2,columnsep=0.75cm,noautomatic=\LECIDX@automatic]}
\lecture@imkdx

% hi index
\def\hindex#1{\def\leci@index@h{#1}\index{#1}}
% sub index
\def\sindex#1{\index{\leci@index@h\lecidx@idxsub #1}}

\def\setIndexLinker#1{\gdef\lecidx@@linker##1##2{#1}}
\def\lecidx@idxactual{?}
\def\lecidx@idxsub{!}
\def\lecidx@idxpage{|}
\setIndexLinker{\hyperref[#1]{#2}}

% sloppy for now, i don't have time :D
\def\lecidx@sanitize#1{%
\StrSubstitute{#1}{\lecidx@idxsub}{:sub:}[\lecidx@tmpl]%
}

% link index
\def\lindex{\@ifstar\lecidx@lindex\lecidx@@lindex}
\robustify\lindex

\newcommand*\lecidx@lindex[3][]{\lecidx@sanitize{#1}\phantomsection\label{lecidx@\lecidx@tmpl @hi@#2@}\index{\ifx!#1!\else#1\lecidx@idxsub\fi#2\lecidx@idxactual\protect\lecidx@@linker{lecidx@\lecidx@tmpl @hi@#2@}{#3}}}

\newcommand*\lecidx@@lindex[2][]{\lecidx@lindex[#1]{#2}{#2}}

% ref index
\def\rindex{\@ifstar\lecidx@rindex\lecidx@@rindex}
\robustify\rindex

\newcommand*\lecidx@rindex[3][]{\lecidx@sanitize{#1}\index{\ifx!#1!\else#1\lecidx@idxsub\fi#2\lecidx@idxactual\protect\lecidx@@linker{lecidx@\lecidx@tmpl @hi@#2@}{#2}}}
\newcommand*\lecidx@@rindex[2][]{\lecidx@rindex[#1]{#2}{#2}}

% sub link index
\def\slindex#1{\lindex[\leci@index@h]{#1}}


% old for compat
\DeclareRobustCommand{\kw}[1]{\textbf{#1}\index{#1}}
\DeclareRobustCommand{\sw}[2][Gruppenname]{#2\index{#1\lecidx@idxsub #2}}
\DeclareRobustCommand{\sr}[3][Gruppenname]{#3\index{#1\lecidx@idxsub #2\lecidx@idxsub #3}}

\endinput