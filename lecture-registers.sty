%% lecture-registers.sty
%%
%% --------------------------------------------------------------------------
%%
%% Autor: Florian Sihler, 21.10.2020
%%
%% Register Support for lectures
%%
\ProvidesPackage{lecture-registers}[2020/10/21 v1.0 registers]

\RequirePackage{etoolbox}

\def\@lecture@definereg#1{
    \expandafter\xdef\csname#1\endcsname{%
        \noexpand\@ifnextchar[%
        {\expandafter\noexpand\csname#1 @hasopt\endcsname}%
        {\expandafter\noexpand\csname#1 @noopt\endcsname}
    }
    \expandafter\xdef\csname#1 @hasopt\endcsname[##1]##2%
    {\expandafter\noexpand\gdef\csname lecture@register@#1\endcsname{##2}%
    \expandafter\noexpand\gdef\csname lecture@register@short@#1\endcsname{##1}}
    \expandafter\xdef\csname#1 @noopt\endcsname##1%
    {\expandafter\noexpand\gdef\csname lecture@register@#1\endcsname{##1}%
    \expandafter\noexpand\gdef\csname lecture@register@short@#1\endcsname{##1}}
    \expandafter\gdef\csname lecture@register@#1\endcsname{}
    \expandafter\gdef\csname lecture@register@short@#1\endcsname{}
}

\forcsvlist{\@lecture@definereg}{title,subtitle,brief,author,duedate,supervisor,keywords,titleimage}

% iterators for handling and parsing author information.
\def\lecture@@add@author#1{%
    \let\lecture@@tmp@old@author\lecture@register@author%
    \expandafter\ifx\expandafter\\\lecture@@tmp@old@author\\%
    \xdef\lecture@register@author{#1}\else%
    \xdef\lecture@register@author{\lecture@@tmp@old@author,#1}\fi%
}
\let\addAuthor\lecture@@add@author

\def\lecture@mail#1{\href{mailto:#1}{#1}}
\let\mail\lecture@mail%

\def\lecture@@parse@author#1 (#2)\@nil{\bgroup\href{mailto:#2}{#1}\egroup}
\def\lecture@@parse@author@getmail#1 (#2)\@nil{#2}

\def\LinkAuthor#1{\protected@edef\@tmp{#1}\expandafter\lecture@@parse@author\@tmp\@nil}

\newcounter{lecture@counter@tmp@a}
\def\lecture@@typeset@author#1{%
    \setcounter{lecture@counter@tmp@a}{0}% start with an offset
    \foreach \@tmp in {#1}%
        {\expandafter\ifx\expandafter\\\@tmp\\\else%
            \stepcounter{lecture@counter@tmp@a}\fi}%
    \edef\lecture@author@totallength{\arabic{lecture@counter@tmp@a}}%
    \setcounter{lecture@counter@tmp@a}{0} % stored the length of the list
    \foreach \lecture@@tmp@curauthor in {#1} {%
        \expandafter\ifx\expandafter\\\lecture@@tmp@curauthor\\%empty => ignore
        \else\stepcounter{lecture@counter@tmp@a}%
            \ifnum\thelecture@counter@tmp@a>1%
            \ifnum\thelecture@counter@tmp@a=\lecture@author@totallength%
                ~und \else,\space\fi\fi
            \expandafter\lecture@@parse@author\lecture@@tmp@curauthor\@nil%
        \fi%
    }%
}

\newcommand*\lecture@typeset@authors{%
    \edef\@tmp{\noexpand\lecture@@typeset@author{\lecture@register@author}}\@tmp}
\let\typesetAuthor\lecture@typeset@authors

\def\lecture@firstoftwo#1#2{#1}
\def\lecture@secondoftwo#1#2{#2}

\def\lecture@r#1{\@nameuse{lecture@register@#1}}
\def\lecture@@chkempty{\expandafter\ifx\expandafter!\@@lecture@tmp!\expandafter\lecture@firstoftwo\else\expandafter\lecture@secondoftwo\fi}
\def\iflecture@e#1{\protected@edef\@@lecture@tmp{#1}\lecture@@chkempty}
\def\iflecture@er#1{\protected@edef\@@lecture@tmp{\lecture@r{#1}}\lecture@@chkempty}
\def\lecture@rs#1{\@nameuse{lecture@register@short@#1}}
\def\iflecture@ers#1{\protected@edef\@@lecture@tmp{\lecture@rs{#1}}\lecture@@chkempty}

\AtBeginDocument{%
    \@ifpackageloaded{hyperref}{%
    \hypersetup{pdftitle={\lecture@r{title}},%
        pdfsubject={\lecture@r{subtitle}},%
        pdfauthor={\lecture@r{author}},%
        pdfkeywords={\lecture@r{keywords}}}%
    }{}%
}

\endinput